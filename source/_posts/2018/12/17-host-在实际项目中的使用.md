---
title: host 在实际项目中的使用
description: <!-- more -->
translate_title: the-use-of-host-in-practical-projects
date: 2018-12-17 15:01:27
updated: 2018-12-17 15:01:27
tags:
  - Host
  - Hosts
  - 代理
  - 转发
  - SwitchHosts
  - 移动端
categories:
  - Host
---

> 今天体会到了实践出真知，回过头来看发现已经有了成熟的案例，大家都在使用，在这里记录我自己下体验。

# 不对等环境的联调过程

## 引子
对接外部系统微信、支付宝的支付通道，因为对方只能在线上环境测试且对方不将我方测试域名加入对方线上白名单中，导致我方在测试环境中使用对方线上数据环境测试不能完美进行下去。

因为微信支付宝的实现方式不同，故先解决微信支付的问题。


## 服务器端配置修改

首先考虑对方只能使用线上域名，故寻求运维，只要进入我方网络该域名转发到测试环境，失败。

因为项目使用的smarty3，且转发的域名使用的配置，在开始修改之前修改代码配置为线上域名。

然后整合我手上掌握的资源，前端服务器（代码+nginx），因完全使用线上域名，故肯定不能请求到测试服务器，失败。

只能考虑使用本机配置host，遂行之，然败矣；验证使用ip直接访问，仍失败，然后在nginx `server name` 中添加 该ip，访问成功。喜。

接下来使用域名访问还是失败，继续在nginx `server name` 中添加该域名，访问成功；到此服务器端的配置完成

## 本机修改

本机除了上面配置的host，还需要如下调整。

因为最终还是需要在手机上配置，所以要想办法把手机的请求转发给服务器，只能使用电脑拦截然后转发到服务器。

拦截使用fiddler代理，拦截手机上的请求。且测试环境smarty日志有输出，成功。

到此使用的工具都调试好了。
但是微信还是不能访问成功，因为手机挂代理的时候微信网页授权不能访问（具体原因不明）；
这时只能通过先去掉代理，然后手动取得想要的数据，拼接一个线上域名的url；在手机挂代理的情况下访问该地址，有效。

后面就是微信支付成功了。

> 但是原本功能完好的微信初始化功能、微信扫二维码加备注功能，都因为不能正确执行到wx.ready方法导致页面不能正确显示，故把对应代码注销掉才可以执行。
> 回归测试使用恢复的代码分支原有功能又没有问题，故归结为代理导致的问题。

## 支付宝的支付

因为有了微信的案例，所以支付宝使用同样的方法进行测试。

百般使用后发现，支付宝里面打开的页面根本不被拦截到，使用了iphone和android都不会被拦截到；

怀疑是自己电脑问题，又换了一台电脑使用fiddler拦截，还是不可以；

咨询了在阿里的同学，也是啥都不知道；建议我配置手机host，找了一块android设备，修改之后不生效，放弃；

最终还是使用查找参数，手动拼接url的方式，而且是测试环境地址，就不需要挂代理。

一直想让程序自动跑不需要人工干预的方式，由于缺少相关经验，浪费不少时间。

# 不对等环境联调总结
因为开发环境的需要，需要对本机进行管理，如果是手机联调还需要配置代理。。。。

1. 如果测试环境有nginx且有`server name`，需要在此将生产域名添加进来
2. 修改代码中授权回调地址为生产地址
3. 修改本机host，添加线上域名到测试环境ip的host转发
4. 配置fiddler拦截器
5. 修改手机代理地址
6. 如果出现像微信网页授权在手机配置代理后不能访问的情况，需要手动拼接后续url。
7. 记得要还原手机代理、本机host、修改的代码、nginx配置。

# 使用工具管理host

推荐使用 [SwitchHosts](https://github.com/oldj/SwitchHosts/blob/master/README_cn.md) 管理工具

这是一个用于快速切换 hosts 文件的小程序，基于 Electron 开发，同时使用了 React、Ant Design 以及 CodeMirror 等框架/库。

## 功能特性
- 快速切换 hosts
- hosts 文件语法高亮
- 在线 hosts 方案：适用于多人协作，将host文件放置在网络上供他人使用
- 系统托盘图标快速切换
- macOS: 支持 Alfred workflow 快速切换

## 工具管理host注意事项
1、运行时要以管理员方式运行，不然会提示无修改权限。在SwitchHosts.exe右键—以管理员身份运行
2、如果是绿色单文件版，最好是放在一个文件夹里面再运行，因为会exe所在的目录下生成配置文件和其他文件夹。
3、如果双击运行后不能显示SwitchHost界面，但是任务管理器里面能看到SwitchHost的进程，一般是由于hosts文件字符集不统一，导致hosts文件出现乱码，不能被SwitchHost打开，这时候只要删除C:\windows\system32\drivers\etc\hosts 即可。
4、如果使用了代理，修改 Hosts 也不会生效。因为浏览器会优先考虑代理工具的代理，建议调试的时候先关闭代理。
5、修改了hosts不生效，一般需要重启浏览器，如果是google浏览器可以不用重启，可以借助chrome://net-internals/#dns  chrome://net-internals/#sockets  清掉keep-alive 和清浏览器 DNS 缓存。

# 调试中使用的工具

## 代理工具
Fiddler4 以及 Charles，其中Fiddler4 可以安装在 Windows上，Charles安装在Mac上。

## Android 调试工具
Android 使用adb远程控制，但是需要root权限